# TCP服务器客户端跨机器测试指南

## 测试环境准备

### 服务器端机器（Machine A）
1. **获取程序文件**
   ```bash
   # 如果有源码，编译程序
   make
   
   # 或者直接复制编译好的可执行文件
   # servertcp, clienttcp
   ```

2. **查看服务器IP地址**
   ```bash
   # 查看所有网络接口
   ip addr show
   
   # 或使用ifconfig
   ifconfig
   
   # 获取主要IP地址
   hostname -I
   ```

3. **配置防火墙（如果需要）**
   ```bash
   # Ubuntu/Debian
   sudo ufw allow 8888
   sudo ufw status
   
   # CentOS/RHEL/Fedora
   sudo firewall-cmd --permanent --add-port=8888/tcp
   sudo firewall-cmd --reload
   sudo firewall-cmd --list-ports
   
   # 临时关闭防火墙（仅测试用）
   sudo ufw disable  # Ubuntu
   sudo systemctl stop firewalld  # CentOS
   ```

### 客户端机器（Machine B, C, D...）
1. **获取客户端程序**
   ```bash
   # 复制clienttcp程序到客户端机器
   # 或者在客户端机器上编译
   gcc -Wall -Wextra -std=c99 -pthread -o clienttcp clienttcp.c
   ```

2. **测试网络连通性**
   ```bash
   # 替换SERVER_IP为实际的服务器IP地址
   ping SERVER_IP
   
   # 测试端口连通性
   telnet SERVER_IP 8888
   # 或使用nc
   nc -v SERVER_IP 8888
   ```

## 测试步骤

### 第一步：启动服务器
在服务器端机器上：

```bash
# 启动服务器程序
./servertcp

# 选择服务器类型
# 1 - 基础服务器（单线程，用于测试基本功能）
# 2 - 多进程服务器（每个客户端一个进程）
# 3 - 多线程服务器（推荐，性能最好）
```

**示例输出：**
```
TCP服务器程序
请选择服务器类型:
1. 基础TCP服务器 (单线程，一次处理一个客户端)
2. 多进程TCP服务器 (每个客户端一个进程)
3. 多线程TCP服务器 (每个客户端一个线程)
请输入选择 (1-3): 3

=== 启动多线程TCP服务器 ===
多线程TCP服务器正在监听端口 8888...
每个客户端连接将创建一个新线程处理
```

### 第二步：从客户端连接
在每台客户端机器上：

```bash
# 连接到服务器（替换192.168.1.100为实际服务器IP）
./clienttcp 192.168.1.100

# 或指定端口
./clienttcp 192.168.1.100 8888
```

**示例输出：**
```
TCP客户端程序
正在连接到服务器 192.168.1.100:8888...
成功连接到服务器!
服务器消息: 欢迎连接到TCP服务器! (进程ID: 1234, 线程ID: 140123456789)

使用说明:
- 输入消息并按回车发送
- 输入 'quit' 退出程序
- 按 Ctrl+C 强制退出
========================================
请输入消息: 
```

### 第三步：测试通信
1. **在客户端输入消息**
   ```
   请输入消息: Hello from Client 1
   服务器回复: 服务器回复 (进程ID: 1234, 线程ID: 140123456789): Hello from Client 1
   ```

2. **同时从多个客户端发送消息**
   - 在不同机器上同时输入消息
   - 观察服务器端的输出，验证并发处理

3. **退出测试**
   ```
   请输入消息: quit
   正在断开连接...
   客户端已关闭
   ```

## 测试场景

### 场景1：基础功能测试
- **目标**: 验证基本的TCP通信功能
- **步骤**: 
  1. 启动基础服务器（选项1）
  2. 连接一个客户端
  3. 发送几条消息
  4. 正常退出

### 场景2：并发测试
- **目标**: 测试多客户端同时连接
- **步骤**:
  1. 启动多线程服务器（选项3）
  2. 从不同机器同时连接多个客户端
  3. 各客户端同时发送消息
  4. 观察服务器处理情况

### 场景3：稳定性测试
- **目标**: 测试长时间运行稳定性
- **步骤**:
  1. 启动服务器
  2. 客户端连接后发送大量消息
  3. 测试异常断开和重连

### 场景4：网络中断测试
- **目标**: 测试网络异常情况
- **步骤**:
  1. 正常连接后，断开网络
  2. 观察客户端和服务器的反应
  3. 恢复网络后重新连接

## 实际测试示例

### 服务器端（192.168.1.100）
```bash
./servertcp
# 选择 3 (多线程服务器)

# 输出示例：
=== 启动多线程TCP服务器 ===
多线程TCP服务器正在监听端口 8888...
每个客户端连接将创建一个新线程处理
客户端 192.168.1.101:45678 已连接 (进程ID: 1234, 线程ID: 140001)
客户端 192.168.1.102:45679 已连接 (进程ID: 1234, 线程ID: 140002)
收到来自 192.168.1.101:45678 的消息: Hello from Machine B
收到来自 192.168.1.102:45679 的消息: Hello from Machine C
```

### 客户端1（192.168.1.101）
```bash
./clienttcp 192.168.1.100
# 输入消息: Hello from Machine B
```

### 客户端2（192.168.1.102）
```bash
./clienttcp 192.168.1.100
# 输入消息: Hello from Machine C
```

## 自动化测试脚本

### 并发测试脚本
```bash
# 在服务器端运行，测试本地并发
./test_concurrent.sh 127.0.0.1 8888 5

# 在客户端运行，测试远程并发
./test_concurrent.sh 192.168.1.100 8888 5
```

### 批量测试脚本
```bash
#!/bin/bash
# 批量测试不同服务器类型

SERVER_IP="192.168.1.100"

for server_type in 1 2 3; do
    echo "测试服务器类型 $server_type"
    
    # 启动对应类型的服务器（需要手动启动）
    echo "请在服务器端启动类型 $server_type 的服务器，然后按回车继续..."
    read
    
    # 运行测试
    ./test_concurrent.sh $SERVER_IP 8888 3
    
    echo "类型 $server_type 测试完成，按回车继续下一个..."
    read
done
```

## 常见问题解决

### 连接被拒绝
```bash
# 检查服务器是否运行
ps aux | grep servertcp

# 检查端口是否被占用
netstat -tlnp | grep 8888
ss -tlnp | grep 8888

# 检查防火墙
sudo ufw status
sudo firewall-cmd --list-ports
```

### 权限问题
```bash
# 给程序执行权限
chmod +x servertcp clienttcp

# 如果需要绑定特权端口（<1024）
sudo ./servertcp
```

### 网络不通
```bash
# 检查路由
ping 服务器IP
traceroute 服务器IP

# 检查DNS解析（如果使用域名）
nslookup 服务器域名
```

## 性能监控

### 服务器端监控
```bash
# 监控进程和线程
ps -eLf | grep servertcp

# 监控网络连接
netstat -an | grep 8888

# 监控系统资源
top -p $(pgrep servertcp)
htop
```

### 网络流量监控
```bash
# 监控网络接口流量
iftop -i eth0

# 监控特定端口流量
tcpdump -i any port 8888
```

## 测试报告模板

```
TCP服务器测试报告
================

测试环境:
- 服务器: IP地址, 操作系统, 硬件配置
- 客户端: 数量, IP地址, 操作系统

测试结果:
- 基础服务器: 连接成功/失败, 响应时间
- 多进程服务器: 并发连接数, 资源使用情况
- 多线程服务器: 并发连接数, 响应时间, 稳定性

发现的问题:
- 问题描述
- 重现步骤
- 解决方案

建议:
- 性能优化建议
- 稳定性改进建议
```

## 总结

通过以上测试步骤，您可以全面验证TCP服务器的功能和性能。建议按照从简单到复杂的顺序进行测试，确保每个功能都正常工作后再进行下一步测试。